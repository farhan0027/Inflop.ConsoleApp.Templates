name: Test Templates

on:
  push:
    branches:
      - main
      - master
  pull_request:
    branches:
      - main
      - master

jobs:
  # Check if relevant files changed
  check-changes:
    name: Check for relevant changes
    runs-on: ubuntu-latest
    outputs:
      should-test: ${{ steps.check.outputs.should-test }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Check for template changes
        id: check
        run: |
          # Check if any relevant files changed in the last commit
          # Works for both pull_request and push events

          NULL_SHA="0000000000000000000000000000000000000000"

          if [ "${{ github.event_name }}" = "pull_request" ]; then
            # For PRs, compare base branch with PR head
            BASE_SHA="${{ github.event.pull_request.base.sha }}"
            HEAD_SHA="${{ github.event.pull_request.head.sha }}"
            echo "PR: Comparing $BASE_SHA..$HEAD_SHA"
          else
            # For push events, compare previous commit with current
            BASE_SHA="${{ github.event.before }}"
            HEAD_SHA="${{ github.sha }}"
            echo "Push: Comparing $BASE_SHA..$HEAD_SHA"

            # Handle null SHA (first push to branch, force push, or initial commit)
            if [ "$BASE_SHA" = "$NULL_SHA" ]; then
              echo "⚠ Detected null SHA (new branch, force push, or initial commit)"
              echo "→ Running tests as a safety measure"
              echo "should-test=true" >> $GITHUB_OUTPUT
              exit 0
            fi
          fi

          # Check if any relevant files changed
          if git diff --name-only "$BASE_SHA..$HEAD_SHA" | grep -qE '^(src/|scripts/)'; then
            echo "should-test=true" >> $GITHUB_OUTPUT
            echo "✓ Template-related files changed - running tests"
          else
            echo "should-test=false" >> $GITHUB_OUTPUT
            echo "○ No template changes - skipping tests"
          fi

  test-templates:
    name: Test Templates
    runs-on: ubuntu-latest
    needs: check-changes
    if: ${{ needs.check-changes.outputs.should-test == 'true' }}
    timeout-minutes: 45

    strategy:
      fail-fast: false
      matrix:
        dotnet-version: ['8.0.x', '9.0.x', '10.0.x']

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup .NET SDK ${{ matrix.dotnet-version }}
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: ${{ matrix.dotnet-version }}

      - name: Display .NET version
        run: dotnet --version

      - name: Cache NuGet packages
        uses: actions/cache@v4
        with:
          path: ~/.nuget/packages
          key: ${{ runner.os }}-nuget-${{ hashFiles('**/*.csproj') }}
          restore-keys: |
            ${{ runner.os }}-nuget-

      - name: Make scripts executable
        run: |
          chmod +x scripts/test-all-templates.sh
          chmod +x scripts/sync-shared-files.sh

      - name: Run comprehensive template tests
        id: run-tests
        working-directory: scripts
        run: ./test-all-templates.sh

      - name: Upload test results on failure
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: test-results-dotnet-${{ matrix.dotnet-version }}
          path: scripts/test-results-*.log
          if-no-files-found: warn
          retention-days: 7

      - name: Upload test results on success
        if: success()
        uses: actions/upload-artifact@v4
        with:
          name: test-results-dotnet-${{ matrix.dotnet-version }}-success
          path: scripts/test-results-*.log
          if-no-files-found: warn
          retention-days: 3

  # Summary job - required status check for branch protection
  # Passes successfully when tests are skipped (e.g., README-only changes) or succeed
  test-summary:
    name: All Tests Passed
    runs-on: ubuntu-latest
    needs: [check-changes, test-templates]
    if: ${{ always() }}

    steps:
      - name: Check test results
        run: |
          SHOULD_TEST="${{ needs.check-changes.outputs.should-test }}"
          TEST_RESULT="${{ needs.test-templates.result }}"

          echo "Should test: $SHOULD_TEST"
          echo "Test result: $TEST_RESULT"

          if [ "$SHOULD_TEST" == "false" ]; then
            echo "⏭️  Tests skipped (no template changes detected)"
            echo "Files changed do not affect templates (e.g., README-only changes)"
            echo "## ⏭️ Tests Skipped" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "No template changes detected. Changed files do not affect templates." >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "Tests run only when files in \`src/\` or \`scripts/\` are modified." >> $GITHUB_STEP_SUMMARY
            exit 0
          elif [ "$TEST_RESULT" == "success" ]; then
            echo "✅ All template tests passed successfully"
            echo "## ✅ All Tests Passed" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "All template tests completed successfully across all .NET versions." >> $GITHUB_STEP_SUMMARY
            exit 0
          elif [ "$TEST_RESULT" == "skipped" ]; then
            echo "⏭️  Tests skipped"
            exit 0
          else
            echo "❌ Tests failed or were cancelled (result: $TEST_RESULT)"
            echo "## ❌ Tests Failed" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "Template tests failed. Check the test logs for details." >> $GITHUB_STEP_SUMMARY
            exit 1
          fi
